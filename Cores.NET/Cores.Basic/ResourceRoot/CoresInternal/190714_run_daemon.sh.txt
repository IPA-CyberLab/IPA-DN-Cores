#!/bin/bash

# Automatically generated by the IPA.Cores library

if [ $# -eq 0 ]; then
 echo Usage: run_daemon.sh \<command_line\>
 exit 1
fi

while [ 1 ];
do
    errstr="run_daemon.sh: Config='$IPA_DN_CORES_BUILD_CONFIGURATION': starting the command '$@' ..."
    logger ${errstr}
    $@
    retcode=$?

	# exit code 137: kill -KILL, 143: kill (normal hup)
    if [ $retcode -eq 0 ] || [ $retcode -eq 143 ]
    then
		errstr="run_daemon.sh: Config='$IPA_DN_CORES_BUILD_CONFIGURATION': the command '$@' terminated normally. Returned code: '$retcode'."
		echo ${errstr}
		logger ${errstr}
        break
    fi

	if [ $retcode -eq 82 ]
	then
	    # Rebuild
		errstr="run_daemon.sh: Config='$IPA_DN_CORES_BUILD_CONFIGURATION': the command '$@' terminated with Git Update. Returned code: '$retcode'. Rebuilding..."
		echo ${errstr}
		logger ${errstr}

		$IPA_DN_CORES_DOTNET_EXE clean -c $IPA_DN_CORES_BUILD_CONFIGURATION
		$IPA_DN_CORES_DOTNET_EXE build -c $IPA_DN_CORES_BUILD_CONFIGURATION --force
		retcode2=$?

		if [ retcode2 -ne 0 ]
		then
			errstr="run_daemon.sh: Config='$IPA_DN_CORES_BUILD_CONFIGURATION': the command '$IPA_DN_CORES_DOTNET_EXE' abnormally terminated. Returned code: '$retcode2'. Stopping the bash script..."
			echo ${errstr}
			logger ${errstr}

			exit 1
		fi
	fi

    errstr="run_daemon.sh: Config='$IPA_DN_CORES_BUILD_CONFIGURATION': the command '$@' abnormally terminated. Returned code: '$retcode'. Restarting..."
    echo ${errstr}
    logger ${errstr}

    sleep 2
done
